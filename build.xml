<?xml version="1.0" encoding="UTF-8"?>
<project name="Liferay-Remote-Database-Selector" default="startDB" basedir="." xmlns:if="ant:if" xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:unless="ant:unless">
	<property file="build-ext.properties" />
	<property file="build.properties" />

	<taskdef classpath="lib/ant-contrib.jar" resource="net/sf/antcontrib/antlib.xml" />

	<fail unless="portal-ee.dir" message="Required property: portal-ee.dir is not set, please set it to your Portal-EE directory"/>
	<fail unless="tomcat.dir" message="Required property: tomcat.dir is not set, please set it to your tomcat directory"/>
	<fail unless="lp.plugins.dir" message="Required property: lp.plugins.dir is not set, please set it to your liferay-plugins directory"/>
	<fail unless="remote.host" message="Required property: remote.host is not set"/>
	<fail unless="remote.portal" message="Required property: remote.portal is not set"/>

	<path id="ivy.lib.path">
		<fileset dir="lib" includes="ivy-2.4.0.jar" />
	</path>

	<taskdef classpathref="ivy.lib.path" resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" />

	<macrodef name="compile">
		<sequential>
			<delete dir="classes" />

			<mkdir dir="classes" />

			<javac srcdir="src" destdir="classes" classpath="lib" debug="on" />
		</sequential>
	</macrodef>

	<target name="killSSHTunnel">
		<exec executable="sh">
			<arg value="-c" />
			<arg value="ps axf | grep 9999 | grep -v grep | awk &apos;{print &quot;kill -9 &quot; $1}	&apos;| sh" />
		</exec>
	</target>

	<target name="startDB">
		<compile />

		<input unless:set="database.type" message="database: " addproperty="database.type" />

		<ant antfile="${portal.dir}/build-test.xml" dir="${portal.dir}" target="copy-optional-jars">
			<property name="database.type" value="${database.type}" />
			<property name="todir" value="${portal.dir}/lib/development" />
		</ant>

		<ant antfile="${portal.dir}/build-test.xml" dir="${portal.dir}" target="copy-optional-jars">
			<property name="database.type" value="${database.type}" />
			<property name="todir" value="${tomcat.dir}/webapps/ROOT/WEB-INF/lib" />
		</ant>

		<taskdef name="createPropertiesTask" classname="remote.tasks.CreatePropertiesTask" classpath="classes" />

		<createPropertiesTask dbType="${database.type}" />

		<if>
			<or>
				<equals arg1="${database.type}" arg2="db2" />
				<equals arg1="${database.type}" arg2="oracle" />
				<equals arg1="${database.type}" arg2="sybase" />
			</or>
			<then>
				<if>
					<not>
						<available file="${portal.dir}/modules/private/apps/foundation/portal/portal-dao-db" type="dir" />
					</not>
					<then>
						<copy todir="${portal.dir}/modules/private/apps/foundation/portal/portal-dao-db">
							<fileset dir="${portal-ee.dir}/modules/private/apps/foundation/portal/portal-dao-db" />
						</copy>
					</then>
				</if>

				<taskdef name="deploydaodbtask" classname="remote.tasks.DeployDaoDBTask" classpath="classes" />

				<deploydaodbtask />

				<taskdef name="createTunnelTask" classname="remote.tasks.CreateTunnelTask" classpath="classes" />

				<createTunnelTask dbType="${database.type}" />

				<delete dir="${portal.dir}/modules/private" quiet="true" />
			</then>
		</if>
	</target>

	<!-- Use portal's source formatter to format source. -->

	<target name="format-source">
		<ivy:cachepath
			file="dependencies/com.liferay.source.formatter/ivy.xml"
			pathid="source.formatter.classpath"
			log="download-only"
		/>

		<taskdef classpathref="source.formatter.classpath" resource="com/liferay/source/formatter/ant/taskdefs.properties" />

		<ivy:settings file="ivy-settings.xml" />

		<format-source baseDir="src" />
	</target>
</project>